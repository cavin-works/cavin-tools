name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "macos-latest"
            args: "--target aarch64-apple-darwin"
          - platform: "macos-latest"
            args: "--target x86_64-apple-darwin"
          - platform: "macos-latest"
            args: "--target universal-apple-darwin"
          - platform: "windows-latest"
            args: ""

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies (Linux)
        if: startsWith(matrix.platform, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libssl-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev patchelf pkg-config libsoup-3.0-dev javascriptcoregtk-4.1 libjavascriptcoregtk-4.1-dev
          sudo apt-get install -y libnm-dev xdg-utils

      - name: Rust setup
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || (contains(matrix.args, 'aarch64') && 'aarch64-unknown-linux-gnu' || '') }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Node.js setup
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Get version from tag
        id: get_version
        shell: bash
        run: |
          echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
          echo "Tag: $GITHUB_REF_NAME -> Version: ${GITHUB_REF_NAME#v}"

      - name: Update version in config files
        shell: bash
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          # Update package.json
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json'));
            pkg.version = '$VERSION';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "
          # Update Cargo.toml
          cd src-tauri
          sed -i.bak "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
          rm -f Cargo.toml.bak
          # Update tauri.conf.json
          node -e "
            const fs = require('fs');
            const config = JSON.parse(fs.readFileSync('tauri.conf.json'));
            config.version = '$VERSION';
            fs.writeFileSync('tauri.conf.json', JSON.stringify(config, null, 2) + '\n');
          "
          echo "Updated version to $VERSION"

      - name: Generate CHANGELOG
        id: changelog
        shell: bash
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"

          # ç”Ÿæˆ CHANGELOGï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
          # conventional-changelog-cli å·²åœ¨ package.json ä¸­å®‰è£…
          pnpm conventional-changelog -p angular -i CHANGELOG.md -s -r 0 2>/dev/null || true

          # ç¿»è¯‘ä¸ºä¸­æ–‡å¹¶æå–å½“å‰ç‰ˆæœ¬çš„ notes
          python3 << EOF
          import re
          import os

          version = "${VERSION}"

          with open('CHANGELOG.md', 'r', encoding='utf-8') as f:
              content = f.read()

          # ç¿»è¯‘ç±»å‹ä¸ºä¸­æ–‡
          translations = {
              '### Features': '### âœ¨ æ–°åŠŸèƒ½',
              '### Bug Fixes': '### ğŸ› Bug ä¿®å¤',
              '### Performance Improvements': '### âš¡ æ€§èƒ½ä¼˜åŒ–',
              '### Documentation': '### ğŸ“ æ–‡æ¡£',
              '### Tests': '### âœ… æµ‹è¯•',
              '### Build': '### ğŸ”§ æ„å»º/å·¥å…·',
              '### Refactor': '### â™»ï¸ é‡æ„',
              '### Styles': '### ğŸ’„ æ ·å¼',
              '### Reverts': '### âª å›é€€'
          }

          for en, zh in translations.items():
              content = content.replace(en, zh)

          # æå–å½“å‰ç‰ˆæœ¬éƒ¨åˆ†
          pattern = r'## \\[v?' + re.escape(version) + r'.*?\\n(.*?)(?=\\n## \\[|\$)'
          match = re.search(pattern, content, re.DOTALL)

          if match:
              current_notes = match.group(1).strip()
          else:
              # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å½“å‰ç‰ˆæœ¬ï¼Œä½¿ç”¨é€šç”¨æ¶ˆæ¯
              current_notes = "æŸ¥çœ‹å®Œæ•´æ›´æ–°æ—¥å¿—è¯·è®¿é—® [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md)"

          # ä¿å­˜æ›´æ–°åçš„ CHANGELOG
          with open('CHANGELOG.md', 'w', encoding='utf-8') as f:
              f.write(content)

          # ä¿å­˜å½“å‰ç‰ˆæœ¬çš„ notes
          with open('/tmp/release_notes.txt', 'w', encoding='utf-8') as f:
              f.write(current_notes)

          print(current_notes)
          EOF

          # æäº¤ CHANGELOG æ›´æ–°
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md package.json src-tauri/Cargo.toml src-tauri/tauri.conf.json
          git diff --staged --quiet || git commit -m "docs: æ›´æ–° CHANGELOG å’Œç‰ˆæœ¬å· [skip ci]"
          git push

          # ä¿å­˜ notes åˆ° output
          echo "NOTES<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/release_notes.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "Cavin Tools ${{ github.ref_name }}"
          releaseBody: ${{ steps.changelog.outputs.NOTES }}
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}
